<!DOCTYPE html>
<html lang="en">
<head>
  <title>Beaker!</title>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/3.0.2/normalize.min.css" />
  <link rel="stylesheet" href="http://getskeleton.com/dist/css/skeleton.css" />
</head>
<body>
  <div class="container">
    <h1>Beaker!</h1>

    <!-- Not authenticated -->
    <div id="not-authenticated">

      <div class="row">
        <!-- Register -->
        <div class="four columns">
          <form id="register">
            <h3>Register</h3>
              <label for="register-email">Email</label>
              <input type="text" name="email" id="register-email">

              <label for="register-password">Password</label>
              <input type="password" name="password" id="register-password">

              <label for="register-password-confirmation">Password confirmation</label>
              <input type="password" name="password_confirmation" id="register-password-confirmation">

              <br>
              <button type="submit">Submit</button>
          </form>
        </div>

        <!-- Login -->
        <div class="four columns">
          <form id="signin">
            <h3>Login</h3>
            <label for="signin-email">Email</label>
            <input type="text" name="email" id="signin-email">

            <label for="signin-password">Password</label>
            <input type="password" name="password" id="signin-password">

            <br>
            <button type="submit">Submit</button>
          </form>
        </div>

        <!-- Reset Password -->
        <div class="four columns">
          <form id="forgot-password">
            <h3>Forgot Password?</h3>
            <label for="forgot-password-email">Email</label>
            <input type="text" name="email" id="forgot-password-email">
            <button type="submit">Submit</button>
          </form>

          <form id="reset-password" style="display: none">
            <h3>Forgot Password?</h3>
            <label for="reset-password-token">Reset Token</label>
            <input type="text" name="token" id="reset-password-token">

            <label for="reset-password-password">New Password</label>
            <input type="password" name="password" id="reset-password-password">

            <label for="reset-password-password-confirmation">Password confirmation</label>
            <input type="password" name="password_confirmation" id="reset-password-password-confirmation">

            <button type="submit">Submit</button>
          </form>
        </div>

      </div>
    </div>

    <!-- Authenticated! -->
    <div id="authenticated" style="display: none;">
      <div class="row">
        <h3>Welcome!</h3>

        <form id="signout">
          <button type="submit">Sign out</button>
        </form>


      </div>

    </div>
  </div> <!-- /container -->

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

  <script type="text/javascript">
    'use strict';

    $(function() {
      var Session = {
        token: null,

        signIn: function(token) {
          Session.token = token;
          Session.toggleViews();
        },

        signOut: function() {
          Session.token = null;
          Session.toggleViews();
        },

        toggleViews: function() {
          if (Session.token) {
            $('#not-authenticated').hide();
            $('#authenticated').show();
          } else {
            $('#not-authenticated').show();
            $('#authenticated').hide();
          }
        }
      };

      var api = {
        perform: function(method, url, data, callback) {
          // TODO: ADD HEADERS HERE
          $.ajax({
            type: method,
            url: url,
            data: data,
            dataType: 'text',
            success: function(data) {
              var json = null;

              try {
                json = JSON.parse(data);
              } catch(e) {}

              api.handleSuccess(json);

              if (callback) { callback(null, json); }
            },
            error: function(xhr) {
              var json = null;

              try {
                json = JSON.parse(xhr.responseText);
              } catch(e) {}

              var errors = json && json.errors && json.errors.messages || [];
              api.handleError(errors);
              if (callback) { callback(errors); }
            }
          });
        },

        post: function(url, data, callback) {
          api.perform('POST', url, data, callback);
        },

        put: function(url, data, callback) {
          api.perform('PUT', url, data, callback);
        },

        del: function(url, callback) {
          api.perform('DELETE', url, {}, callback);
        },

        handleSuccess: function(data) {
          if (!data) { return; }

          if (data.session && data.session.token) {
            Session.signIn(data.session.token);
          }
        },

        handleError: function(errors) {
          if (errors.length > 0) {
            alert(errors.join('. '));
          }
        }
      };

      $(document).on('submit', 'form#register', function(e) {
        e.preventDefault();

        api.post('/api/v1/users', { user: $(this).serializeObject() });
      });

      $(document).on('submit', 'form#signin', function(e) {
        e.preventDefault();

        api.post('/api/v1/sessions', $(this).serializeObject());
      });

      $(document).on('submit', 'form#forgot-password', function(e) {
        e.preventDefault();

        api.post('/api/v1/password_resets', $(this).serializeObject(), function(err) {
          if (!err) {
            $('form#reset-password').show();
          }
        });
      });

      $(document).on('submit', 'form#reset-password', function(e) {
        e.preventDefault();

        var data = $(this).serializeObject();
        var token = data['token'];
        delete data['token'];

        api.put('/api/v1/password_resets/' + token, data, function(err) {
          if (!err) {
            $('form#reset-password').hide();
            $('form#signin input#signin-email').val($('form#forgot-password input#forgot-password-email').val());
            $('form#signin input#signin-password').focus();
          }
        });
      });

      $(document).on('submit', 'form#signout', function(e) {
        e.preventDefault();

        api.del('/api/v1/sessions', function(err) {
          if (!err) {
            Session.signOut();
          }
        });
      });

      $.fn.serializeObject = function() {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function() {
          if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
              o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
          } else {
            o[this.name] = this.value || '';
          }
        });
        return o;
      };

    });
  </script>
</body>
</html>


