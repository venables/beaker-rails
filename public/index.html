<!DOCTYPE html>
<html lang="en">
<head>
  <title>Beaker!</title>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/3.0.2/normalize.min.css" />
  <link rel="stylesheet" href="http://getskeleton.com/dist/css/skeleton.css" />
</head>
<body>
  <div class="container">
    <h1>Beaker!</h1>

    <div id="not-authenticated">

      <!-- Login, Register -->
      <div class="row">
        <!-- Register -->
        <div class="six columns">
          <form id="register">
            <h3>Register</h3>
              <label for="register-email">Email</label>
              <input type="text" name="email" id="register-email">

              <label for="register-password">Password</label>
              <input type="password" name="password" id="register-password">

              <label for="register-password-confirmation">Password confirmation</label>
              <input type="password" name="password_confirmation" id="register-password-confirmation">

              <br>
              <button type="submit">Submit</button>
          </form>
        </div>

        <!-- Login -->
        <div class="six columns">
          <form id="login">
            <h3>Login</h3>
            <label for="login-email">Email</label>
            <input type="text" name="email" id="login-email">

            <label for="login-password">Password</label>
            <input type="password" name="password" id="login-password">

            <br>
            <button type="submit">Submit</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Authenticated! -->
    <div id="authenticated" style="display: none;">
      <div class="row">
        <h3>Auth'd!</h3>
      </div>

    </div>
  </div> <!-- /container -->

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

  <script type="text/javascript">
    'use strict';

    $(function() {
      var Session = {
        token: null,

        signIn: function(token) {
          Session.token = token;
          Session.toggleViews();
        },

        signOut: function() {
          Session.token = null;
          Session.toggleViews();
        },

        toggleViews: function() {
          if (Session.token) {
            $('#not-authenticated').hide();
            $('#authenticated').show();
          } else {
            $('#not-authenticated').show();
            $('#authenticated').hide();
          }
        }
      };

      var api = {
        post: function(url, data, callback) {
          $.ajax({
            type: 'POST',
            url: url,
            data: data,
            dataType: 'json',
            success: function(data) {
              api.handleSuccess(data);
              callback(null, data);
            },
            error: function(xhr) {
              var errors = xhr.responseJSON.errors || [];
              api.handleError(errors);
              callback(errors);
            }
          });
        },

        handleSuccess: function(data) {
          if (data.session && data.session.token) {
            Session.signIn(data.session.token);
          }
        },

        handleError: function(errors) {
          alert(errors.join('. '));
        }
      };

      $(document).on('submit', 'form#register', function(e) {
        e.preventDefault();

        api.post('/api/v1/users', { user: $(this).serializeObject() }, function(err, data) {
        });
      });


      $.fn.serializeObject = function() {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function() {
          if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
              o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
          } else {
            o[this.name] = this.value || '';
          }
        });
        return o;
      };

    });
  </script>
</body>
</html>


